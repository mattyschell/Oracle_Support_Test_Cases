--Matt Schell, CPB, 8/7/13
--matthew.c.schell@census.gov
--Attempt to add two valid lines to a topology using SDO_TOPO_MAP.ADD_LINEAR_GEOMETRY
--Result on 11.2.0.3 with our current patch set, when adding the second line is ...
--   ORA-29532: Java call terminated by uncaught Java exception:
--   oracle.spatial.topo.InvalidTopoOperationException: Attempted to add an iso node
--   that lies on an existing edge or node
--   ORA-06512: at "MDSYS.SDO_TOPO_MAP", line 403

BEGIN
SDO_TOPO.DELETE_TOPO_GEOMETRY_LAYER('ISO_NODE_LIES','ISO_NODE_LIES_TAB','TOPOGEOM');
exception when others then
null;
end;
/
BEGIN
SDO_TOPO.DROP_TOPOLOGY('ISO_NODE_LIES');
exception when others then
null;
end;
/
BEGIN
execute immediate 'DROP TABLE ISO_NODE_LIES_TAB';
exception when others then
null;
end;
/
--Create topology
EXEC SDO_TOPO.CREATE_TOPOLOGY('ISO_NODE_LIES' ,.05,8265,NULL,NULL,NULL,NULL,16);
--insert universal face
INSERT INTO ISO_NODE_LIES_FACE$ VALUES (-1, null, sdo_list_type(), sdo_list_type(), null);
commit;
--create dummy feature table
CREATE TABLE ISO_NODE_LIES_TAB(mykey NUMBER, topogeom MDSYS.sdo_topo_geometry);
--add table to topology
EXEC SDO_TOPO.add_topo_geometry_layer('ISO_NODE_LIES','ISO_NODE_LIES_TAB','TOPOGEOM','LINE');
--load a topomap
BEGIN
SDO_TOPO_MAP.DROP_TOPO_MAP('ISO_NODE_LIES_MAP');
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/
EXEC SDO_TOPO_MAP.CREATE_TOPO_MAP('ISO_NODE_LIES','ISO_NODE_LIES_MAP');
EXEC SDO_TOPO_MAP.LOAD_TOPO_MAP('ISO_NODE_LIES_MAP', 'TRUE','TRUE');
--validate the edge geometry we wish to insert
DECLARE
numarray  SDO_NUMBER_ARRAY;
BEGIN

numarray := SDO_TOPO_MAP.ADD_LINEAR_GEOMETRY(NULL,SDO_GEOMETRY
(
   2002,
   8265,
   NULL,
   SDO_ELEM_INFO_ARRAY
   (
      1,
      2,
      1
   ),
   SDO_ORDINATE_ARRAY
   (
      -103.660767466915373802294197957962751389,
      45.94523100716546082367131020873785018921,
      -103.577083000000001788976078387349843979,
      45.94528300000000342606654157862067222595,
      -103.55871000000000492491381010040640831,
      45.94513100000000349609763361513614654541,
      -103.434850999999994769495970103889703751,
      45.94529100000009691484592622146010398865,
      -103.432393000000004690264177042990922928,
      45.94531300000009821360436035320162773132,
      -103.418040000000004852154233958572149277,
      45.94518599999999963756636134348809719086,
      -103.411325000000005047695594839751720428,
      45.94526400000010113444659509696066379547,
      -103.375460000000003901732270605862140656,
      45.94479700000000121917764772661030292511,
      -103.369147999999995590769685804843902588,
      45.94515200000009969016900868155062198639,
      -103.28410900000000083309714682400226593,
      45.94515200000009969016900868155062198639,
      -103.284092000000001121406967286020517349,
      45.94514900000010015901352744549512863159,
      -103.218395999999998480234353337436914444,
      45.94520800000000093632479547522962093353,
      -103.210633999999998877683538012206554413,
      45.94522200000000111685949377715587615967,
      -103.161250999999992927769199013710021973,
      45.94530900000000173122316482476890087128,
      -103.140939000000003034074325114488601685,
      45.94525699999999801548256073147058486938,
      -103.097871999999995296093402430415153503,
      45.94526199999999960255081532523036003113,
      -103.07847700000000656928023090586066246,
      45.94528900000000248837750405073165893555,
      -103.047779000000005567017069552093744278,
      45.9453350000000000363797880709171295166,
      -103.026058000000006131813279353082180023,
      45.94530700000009915129339788109064102173,
      -102.995345000000000368345354218035936356,
      45.94516600000000039472070056945085525513,
      -102.989902000000000725776772014796733856,
      45.94521100000009994346328312531113624573,
      -102.920482000000006905793270561844110489,
      45.94503799999999671399564249441027641296,
      -102.880251999999998702151060570031404495,
      45.94506899999999660622052033431828022003,
      -102.704870999999997138729668222367763519,
      45.94507200000000324280335917137563228607,
      -102.674076999999996928636392112821340561,
      45.94527399999999772717274026945233345032,
      -102.672473999999994020981830544769763947,
      45.94524400000010189160093432292342185974,
      -102.666684000000003607055987231433391571,
      45.94530700000009915129339788109064102173,
      -102.651619999999994092831911984831094742,
      45.94545000000000101181285572238266468048,
      -102.642555000000001541593519505113363266,
      45.94540400000000346381057170219719409943,
      -102.558578999999994607605913188308477402,
      45.94512900000010091616786667145788669586,
      -102.550946999999993636265571694821119308,
      45.94501499999999793999450048431754112244,
      -102.476023999999995339749148115515708923,
      45.94518300000000010641088010743260383606,
      -102.467562999999998396560840774327516556,
      45.94515900000010333315003663301467895508,
      -102.459586000000001604348653927445411682,
      45.94508100000000183626980287954211235046,
      -102.446419000000005894435162190347909927,
      45.94508299999999678675521863624453544617,
      -102.425397000000003799868864007294178009,
      45.945041000000003350578481331467628479,
      -102.425358000000002789420250337570905685,
      45.94498999999999711008058511652052402496,
      -102.420173000000005458787200041115283966,
      45.94507000000000118689058581367135047913,
      -102.410346000000004096364136785268783569,
      45.94507900000009925634003593586385250092,
      -102.406176000000002090928319375962018967,
      45.94499700000000075306161306798458099365,
      -102.398574999999993906385498121380805969,
      45.94486800000009907307685352861881256104,
      -102.396359000000003902641765307635068893,
      45.94491599999999920100890449248254299164,
      -102.392767000000006305526767391711473465,
      45.94497899999999646070136805064976215363,
      -102.392696000000000822183210402727127075,
      45.9449510000000032050593290477991104126,
      -102.354282999999995240614225622266530991,
      45.94490100000000154523149831220507621765,
      -102.353384000000005471520125865936279297,
      45.94498399999999804776962264440953731537,
      -102.328230000000004906723916064947843552,
      45.9448059999999998126440914347767829895,
      -102.217866999999998256498656701296567917,
      45.94471099999999808005668455734848976135,
      -102.176992999999995959115040022879838943,
      45.94462200000000251520759775303304195404,
      -102.176698000000001798071025405079126358,
      45.94462200000000251520759775303304195404,
      -102.159439000000006103618943598121404648,
      45.94464099999999717738319304771721363068,
      -102.157965000000004351932147983461618423,
      45.94464099999999717738319304771721363068,
      -102.156392999999994231075106654316186905,
      45.94466299999999847614162717945873737335,
      -102.145356000000006702066457364708185196,
      45.9446590000000014697434380650520324707,
      -102.135268999999993866367731243371963501,
      45.94458600000000103591446531936526298523,
      -102.125428999999996904080035164952278137,
      45.94465199999999782676241011358797550201,
      -102.124628000000001293301465921103954315,
      45.94481300000000345562511938624083995819,
      -102.087554999999994720383256208151578903,
      45.94459800000009863651939667761325836182,
      -102.085121999999998365638020914047956467,
      45.94464200000000175805325852707028388977,
      -102.060929999999999040483089629560709,
      45.94462200000000251520759775303304195404,
      -102.000656000000006429218046832829713821,
      45.9445150000000026579982659313827753067,
      -102.000425000000007003109203651547431946,
      45.94458099999999944884621072560548782349,
      -101.998703000000006113623385317623615265,
      45.94455700000000319960236083716154098511,
      -101.992187000000001262378646060824394226,
      45.94447100000000006048139766789972782135,
      -101.989501000000004182766133453696966171,
      45.9444719999999975357241055462509393692,
      -101.973748999999997977283783257007598877,
      45.94445600000010188068699790164828300476,
      -101.957438999999993711753631941974163055,
      45.94448400000000276577338809147477149963,
      -101.957120000000003301465767435729503632,
      45.94448433887622229576663812622427940369
   )
)
);

numarray := SDO_TOPO_MAP.ADD_LINEAR_GEOMETRY(NULL,  SDO_GEOMETRY
(
   2002,
   8265,
   NULL,
   SDO_ELEM_INFO_ARRAY
   (
      1,
      2,
      1
   ),
   SDO_ORDINATE_ARRAY
   (
      -103.066512000000003013155946973711252213,
      45.86698200000000014142642612569034099579,
      -103.075659000000001697117113508284091949,
      45.86686000000000262843968812376260757446,
      -103.07612699999999961164576234295964241,
      45.86685399999999646070136805064976215363,
      -103.076320999999992977791407611221075058,
      45.8667829999999980827851686626672744751,
      -103.076352999999997450686350930482149124,
      45.86323099999999897136149229481816291809,
      -103.07657799999999781448423163965344429,
      45.86316099999999806868800078518688678741,
      -103.076660000000003947207005694508552551,
      45.86324700000000120780896395444869995117,
      -103.076881999999997674422047566622495651,
      45.86338099999999684541762690059840679169,
      -103.077010999999998830389813520014286041,
      45.86344499999999868578015593811869621277,
      -103.077217000000004532012098934501409531,
      45.86351799999999911960912868380546569824,
      -103.077492000000006555637810379266738892,
      45.86354800000000153659129864536225795746,
      -103.078602000000003613422450143843889236,
      45.86354599999999948067852528765797615051,
      -103.084986000000000672116584610193967819,
      45.86354000000000041836756281554698944092,
      -103.087113999999999691681296098977327347,
      45.86353900000000294312485493719577789307,
      -103.08983700000000283125700661912560463,
      45.86354099999999789361027069389820098877,
      -103.098007999999992989614838734269142151,
      45.86354699999999695592123316600918769836,
      -103.100731999999993604433257132768630981,
      45.86354999999999648707671440206468105316,
      -103.102208000000004517460183706134557724,
      45.86355100000000106774677988141775131226,
      -103.106635999999994623976817820221185684,
      45.8635549999999980741449689958244562149,
      -103.107703999999998245584720280021429062,
      45.863556000000002654815034475177526474,
      -103.108112000000005537003744393587112427,
      45.8635590000000021859705157112330198288,
      -103.109611000000001013177097775042057037,
      45.86357100000000031059244065545499324799,
      -103.112217999999998596649675164371728897,
      45.86357600000000189766069524921476840973,
      -103.115593000000004053617885801941156387,
      45.86358299999999843521436559967696666718,
      -103.117949999999993337951309513300657272,
      45.86356700000000330419425154104828834534,
      -103.123322000000001708031049929559230804,
      45.8635980000000031964191293809562921524,
      -103.124538999999998623025021515786647797,
      45.86359499999999655983629054389894008636,
      -103.128647000000000844011083245277404785,
      45.86358599999999796636984683573246002197,
      -103.132755000000003064997144974768161774,
      45.86358599999999796636984683573246002197,
      -103.145081000000004678440745919942855835,
      45.86358599999999796636984683573246002197,
      -103.149190000000004374669515527784824371,
      45.86358599999999796636984683573246002197,
      -103.150115999999997029590304009616374969,
      45.86358599999999796636984683573246002197,
      -103.152305999999995833604771178215742111,
      45.86357499999999731699062976986169815063,
      -103.153346999999996569385984912514686584,
      45.86357799999999684814611100591719150543,
      -103.155679000000006340087566059082746506,
      45.86358500000000049112713895738124847412,
      -103.161613000000002671185939107090234756,
      45.86360200000000020281731849536299705505,
      -103.165818000000001575244823470711708069,
      45.86360200000000020281731849536299705505,
      -103.169976000000005456058715935796499252,
      45.86360200000000020281731849536299705505,
      -103.173789999999996780388755723834037781,
      45.86360200000000020281731849536299705505,
      -103.176192000000000348336470779031515121,
      45.86361300000000085219653556123375892639,
      -103.177788000000006718437361996620893478,
      45.86362100000000197042027139104902744293,
      -103.178725999999997497980075422674417496,
      45.86360200000000020281731849536299705505,
      -103.180182999999999537976691499352455139,
      45.86360200000000020281731849536299705505,
      -103.181190999999998325620254036039113998,
      45.86358599999999796636984683573246002197,
      -103.185042999999993185156199615448713303,
      45.86359399999999908459358266554772853851,
      -103.189980000000005588844942394644021988,
      45.86357100000000031059244065545499324799,
      -103.192413000000001943590177688747644424,
      45.86359399999999908459358266554772853851,
      -103.193268000000003326022124383598566055,
      45.86358299999999843521436559967696666718,
      -103.194839000000001760781742632389068604,
      45.86358299999999843521436559967696666718,
      -103.198807000000002176420821342617273331,
      45.86358299999999843521436559967696666718,
      -103.201055999999994128302205353975296021,
      45.86357499999999731699062976986169815063,
      -103.20080500000000256477505899965763092,
      45.86318299999999936744643491692841053009,
      -103.20081700000000068939698394387960434,
      45.86265099999999961255525704473257064819,
      -103.200952000000000907675712369382381439,
      45.8624549999999970850694808177649974823,
      -103.201121999999998024577507749199867249,
      45.8622119999999995343387126922607421875,
      -103.201723000000001206899469252675771713,
      45.86188500000000090039975475519895553589,
      -103.201978999999994357494870200753211975,
      45.86079900000000009185896487906575202942,
      -103.202316999999993640813045203685760498,
      45.86040599999999756164470454677939414978,
      -103.203339999999997189661371521651744843,
      45.86002400000000278623701888136565685272,
      -103.203383999999999787178239785134792328,
      45.86000800000000054978954722173511981964,
      -103.204547000000005141373549122363328934,
      45.85976099999999888723323238082230091095,
      -103.204616000000001463376975152641534805,
      45.85975299999999776900949655100703239441,
      -103.205392000000003349668986629694700241,
      45.85950199999999910005499259568750858307,
      -103.205839999999994915924617089331150055,
      45.85935800000000028830982046201825141907,
      -103.206042999999993980964063666760921478,
      45.85895200000000215823092730715870857239,
      -103.206327000000001703483576420694589615,
      45.85761200000000314958015223965048789978,
      -103.206416000000004373760020826011896133,
      45.8572619999999986362126946914941072464,
      -103.206468000000000984073267318308353424,
      45.8570640000000011582415027078241109848,
      -103.206192000000001485204847995191812515,
      45.85644299999999873307388043031096458435,
      -103.206152000000002999513526447117328644,
      45.85634199999999793817551108077168464661,
      -103.205168000000000461113813798874616623,
      45.85540600000000210911821341142058372498,
      -103.204871999999994613972376100718975067,
      45.85520000000000351292328559793531894684,
      -103.204187000000004559296939987689256668,
      45.85472399999999737474354333244264125824,
      -103.203627999999994813151715788990259171,
      45.8541850000000010822986951097846031189,
      -103.203333999999998127350409049540758133,
      45.85367099999999851434040465392172336578,
      -103.203235000000006493792170658707618713,
      45.85341400000000078307493822649121284485,
      -103.202907999999993648998497519642114639,
      45.85285400000000066711436375044286251068,
      -103.202853000000004612957127392292022705,
      45.85280199999999695137375965714454650879,
      -103.202382999999997537088347598910331726,
      45.8523629999999968731572153046727180481,
      -103.201401000000004160028765909373760223,
      45.8516809999999992442099028266966342926,
      -103.20110400000000083764462033286690712,
      45.85126000000000345835360349155962467194,
      -103.200906000000003359673428349196910858,
      45.84983799999999831698005436919629573822,
      -103.200771000000003141394699923694133759,
      45.84722699999999662168193026445806026459,
      -103.200638999999995348844095133244991302,
      45.84652700000000180580173037014901638031,
      -103.200834999999997876329871360212564468,
      45.84501000000000203726813197135925292969,
      -103.20131999999999550254869973286986351,
      45.84326099999999826195562491193413734436,
      -103.202168000000000347426976077258586884,
      45.84106799999999992678567650727927684784,
      -103.202166000000005396941560320556163788,
      45.84053300000000064073901739902794361115,
      -103.201078999999992902303347364068031311,
      45.83917499999999733972799731418490409851,
      -103.200986999999997806298779323697090149,
      45.83906000000000346972228726372122764587,
      -103.199804000000000314685166813433170319,
      45.83635300000000256659404840320348739624,
      -103.199049000000002251908881589770317078,
      45.83458000000000254203769145533442497253,
      -103.200416000000004146386345382779836655,
      45.83457899999999796136762597598135471344,
      -103.202410999999997898157744202762842178,
      45.83457800000000048612491809763014316559,
      -103.204520000000002255546860396862030029,
      45.83457599999999843021214473992586135864,
      -103.205772999999993544406606815755367279,
      45.83457599999999843021214473992586135864,
      -103.205888999999999100509739946573972702,
      45.83457599999999843021214473992586135864,
      -103.205973999999997658960637636482715607,
      45.83457599999999843021214473992586135864,
      -103.207507000000006769369065295904874802,
      45.83457500000000095496943686157464981079,
      -103.207986000000005333276931196451187134,
      45.83457500000000095496943686157464981079,
      -103.209998999999996271981217432767152786,
      45.83457400000000347972672898322343826294,
      -103.210644999999999527062755078077316284,
      45.83457400000000347972672898322343826294,
      -103.211141999999995277903508394956588745,
      45.83457400000000347972672898322343826294,
      -103.212362999999996304723026696592569351,
      45.83457299999999889905666350387036800385,
      -103.212562000000005468791641760617494583,
      45.83457299999999889905666350387036800385,
      -103.213982000000001448825059924274682999,
      45.83457200000000142381395562551915645599,
      -103.214453000000005999936547596007585526,
      45.8345690000000018926584743894636631012,
      -103.215867000000002917659003287553787231,
      45.83456199999999824967744643799960613251,
      -103.216339000000004944013198837637901306,
      45.8345600000000032991920306812971830368,
      -103.219504000000000587533577345311641693,
      45.83455599999999918736648396588861942291,
      -103.229000999999996679434843827039003372,
      45.83454400000000106274455902166664600372,
      -103.232167000000004009052645415067672729,
      45.83454100000000153158907778561115264893,
      -103.234391999999999711690179537981748581,
      45.83453800000000200043359654955565929413,
      -103.241068999999995980942912865430116653,
      45.83452900000000340696715284138917922974,
      -103.243295000000003369677870068699121475,
      45.83452700000000135105437948368489742279,
      -103.244125999999994292011251673102378845,
      45.8345259999999967703843140043318271637,
      -103.245114999999998417479218915104866028,
      45.83452499999999929514160612598061561584,
      -103.245209000000002674823917914181947708,
      45.83452400000000181989889824762940406799,
      -103.245531999999997196937329135835170746,
      45.83452400000000181989889824762940406799,
      -103.245949999999993451638147234916687012,
      45.83452400000000181989889824762940406799,
      -103.246314999999995620783010963350534439,
      45.83452400000000181989889824762940406799,
      -103.246762000000003922650648746639490128,
      45.8345229999999972392288327682763338089,
      -103.246864000000002192791725974529981613,
      45.8345229999999972392288327682763338089,
      -103.246967999999995413418218959122896194,
      45.83452199999999976398612488992512226105,
      -103.247072000000002844899427145719528198,
      45.83452199999999976398612488992512226105,
      -103.247184000000004289177013561129570007,
      45.83452199999999976398612488992512226105,
      -103.247294999999994047357176896184682846,
      45.83452199999999976398612488992512226105,
      -103.250082000000006132722774054855108261,
      45.8345180000000027575879357755184173584,
      -103.25095399999999301599018508568406105,
      45.8345169999999981769178702961653470993,
      -103.252869000000004007233656011521816254,
      45.8345150000000032264324545394629240036,
      -103.253229000000004589310265146195888519,
      45.8345150000000032264324545394629240036,
      -103.254309000000006335540092550218105316,
      45.8345150000000032264324545394629240036,
      -103.254669000000006917616701684892177582,
      45.8345150000000032264324545394629240036,
      -103.256758000000004926732799503952264786,
      45.83451000000000163936419994570314884186,
      -103.263028000000005590663931798189878464,
      45.83449600000000145882950164377689361572,
      -103.265118000000001075022737495601177216,
      45.83449199999999734700395492836833000183,
      -103.270339000000006990376277826726436615,
      45.83447999999999922238202998414635658264,
      -103.28600099999999883948476053774356842,
      45.83444699999999727424437878653407096863,
      -103.291223000000002230081008747220039368,
      45.83443599999999662486516172066330909729,
      -103.291860999999997261511452961713075638,
      45.83443400000000167437974596396088600159,
      -103.292602000000002249180397484451532364,
      45.83443299999999709370968048460781574249,
      -103.293777000000005727997631765902042389,
      45.8344299999999975625541992485523223877,
      -103.294415999999998234670783858746290207,
      45.83442900000000008731149137020111083984,
      -103.294514000000006603841029573231935501,
      45.83442800000000261206878349184989929199,
      -103.294810999999995715370459947735071182,
      45.83442800000000261206878349184989929199,
      -103.294910000000001559783413540571928024,
      45.83442800000000261206878349184989929199,
      -103.295297000000005027686711400747299194,
      45.8344269999999980313987180124968290329,
      -103.296460999999993646270013414323329926,
      45.8344239999999985002432367764413356781,
      -103.296848999999994589416019152849912643,
      45.8344239999999985002432367764413356781,
      -103.298462999999998146449797786772251129,
      45.83442000000000149384504766203463077545,
      -103.30330800000000124327925732359290123,
      45.83440900000000084446583059616386890411,
      -103.304923000000002275555743835866451263,
      45.83440600000000131331034936010837554932,
      -103.306877000000000066393113229423761368,
      45.83440099999999972624209476634860038757,
      -103.312742000000000075488060247153043747,
      45.83438799999999702095010434277355670929,
      -103.314696999999995341568137519061565399,
      45.83438499999999748979462310671806335449,
      -103.314581000000003996319719590246677399,
      45.85340500000000218960849451832473278046,
      -103.314569000000005871697794646024703979,
      45.85541200000000117142917588353157043457,
      -103.314616000000000894942786544561386108,
      45.85546200000000283125700661912560462952,
      -103.315145000000001118678483180701732635,
      45.88611499999999665533323423005640506744,
      -103.315256000000005087713361717760562897,
      45.88992300000000312820702674798667430878,
      -103.315848000000002571141521912068128586,
      45.92564500000000293766788672655820846558,
      -103.316000999999999976353137753903865814,
      45.93572000000000343788997270166873931885,
      -103.316013999999995576217770576477050781,
      45.93645300000000020190782379359006881714,
      -103.316013999999995576217770576477050781,
      45.93956299999999970395947457291185855865,
      -103.316013999999995576217770576477050781,
      45.94035800000000335785443894565105438232,
      -103.316012999999998100975062698125839233,
      45.94189500000000236923369811847805976868,
      -103.316013999999995576217770576477050781,
      45.94339099999999831425157026387751102448,
      -103.31600299999999492683855351060628891,
      45.94515200000000021418600226752460002899
   )
)
);

END;
/

BEGIN
SDO_TOPO_MAP.COMMIT_TOPO_MAP();
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/

BEGIN
SDO_TOPO_MAP.DROP_TOPO_MAP('ISO_NODE_LIES_MAP');
EXCEPTION
WHEN OTHERS THEN NULL;
END;
/


exit;